<?php
// Exemple données utilisateur
$user = [
    'pseudo' => 'Dupont',
    'email' => 'jean.dupont@example.com',
    'credits' => 45,
    'role' => 'chauffeur-passager', 
    'vehicules' => [
        [
            'id' => 1,
            'marque' => 'Renault',
            'modele' => 'Scenic',
            'couleur' => 'Gris',
            'immatriculation' => 'AB-123-CD',
            'date_immatriculation' => '2020-05-15',
            'places' => 3,
            'electrique' => true
        ]
    ],
    'preferences' => [
        'fumeur' => false,
        'animaux' => true,
        'musique' => 'Autorisée',
        'discussion' => 'Modérée'
    ]
];

include __DIR__ . '/header.phtml';
?>

<main class="bg-light py-4">
    <div class="container-xxl">
        <h1 class="page-title text-center mb-4">Mon profil</h1>

        <div class="row g-4">
            <!-- Colonne gauche : Informations personnelles -->
            <div class="col-12 col-lg-4">
                <!-- Card Infos personnelles -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h2 class="h5 fw-bold mb-3 text-center">
                            <i class="bi bi-person-circle"></i> Informations personnelles
                        </h2>
                        <div class="text-center mb-3">
                            <img src="https://via.placeholder.com/100" alt="Avatar" class="rounded-circle mb-2" width="100" height="100">
                            <button class="btn btn-sm btn-outline-secondary d-block mx-auto mt-2">
                                <i class="bi bi-camera"></i> Modifier la photo
                            </button>
                        </div>
                        <div class="info-item mb-3">
                            <label class="text-muted small">Pseudo</label>
                            <p class="fw-semibold mb-0"><?= htmlspecialchars($user['pseudo']) ?></p>
                        </div>
                        <div class="info-item mb-3">
                            <label class="text-muted small">Email</label>
                            <p class="fw-semibold mb-0"><?= htmlspecialchars($user['email']) ?></p>
                        </div>
                        <div class="info-item mb-3">
                            <label class="text-muted small">Crédits disponibles</label>
                            <p class="fw-bold text-success mb-0 fs-4">
                                <i class="bi bi-coin"></i> <?= $user['credits'] ?> crédits
                            </p>
                        </div>
                        <button class="btn btn-search w-100 btn-sm">
                            <i class="bi bi-pencil"></i> Modifier mes informations
                        </button>
                    </div>
                </div>

                <!-- Card Statut (Chauffeur/Passager) -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="h5 fw-bold mb-3">
                            <i class="bi bi-car-front"></i> Mon statut
                        </h2>
                        <form method="POST" action="update_role.php">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="rolePassager" name="role[]" value="passager"
                                    <?= in_array($user['role'], ['passager', 'chauffeur-passager']) ? 'checked' : '' ?>>
                                <label class="form-check-label" for="rolePassager">
                                    <i class="bi bi-person"></i> Je suis passager
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="roleChauffeur" name="role[]" value="chauffeur"
                                    <?= in_array($user['role'], ['chauffeur', 'chauffeur-passager']) ? 'checked' : '' ?>>
                                <label class="form-check-label" for="roleChauffeur">
                                    <i class="bi bi-steering-wheel"></i> Je suis chauffeur
                                </label>
                            </div>
                            <button type="submit" class="btn btn-search w-100 btn-sm">
                                <i class="bi bi-check2"></i> Enregistrer
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Colonne droite : Véhicules et Préférences -->
            <div class="col-12 col-lg-8">
                <!-- Section Véhicules (si chauffeur) -->
                <?php if (in_array($user['role'], ['chauffeur', 'chauffeur-passager'])) { ?>
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="h5 fw-bold mb-0">
                                <i class="bi bi-car-front-fill"></i> Mes véhicules
                            </h2>
                            <button class="btn btn-search btn-sm" data-bs-toggle="modal" data-bs-target="#addVehicleModal">
                                <i class="bi bi-plus-circle"></i> Ajouter un véhicule
                            </button>
                        </div>

                        <?php if (!empty($user['vehicules'])) { ?>
                            <?php foreach ($user['vehicules'] as $vehicule) { ?>
                            <div class="vehicle-card p-3 mb-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h3 class="h6 fw-bold mb-1">
                                            <?= htmlspecialchars($vehicule['marque']) ?> <?= htmlspecialchars($vehicule['modele']) ?>
                                            <?php if ($vehicule['electrique']) { ?>
                                                <span class="badge bg-success ms-2">
                                                    <i class="bi bi-ev-front"></i> Électrique
                                                </span>
                                            <?php } ?>
                                        </h3>
                                        <div class="vehicle-details small text-muted">
                                            <p class="mb-1">
                                                <i class="bi bi-palette"></i> Couleur: <?= htmlspecialchars($vehicule['couleur']) ?>
                                            </p>
                                            <p class="mb-1">
                                                <i class="bi bi-credit-card-2-front"></i> <?= htmlspecialchars($vehicule['immatriculation']) ?>
                                            </p>
                                            <p class="mb-1">
                                                <i class="bi bi-calendar"></i> 1ère immatriculation: <?= date('d/m/Y', strtotime($vehicule['date_immatriculation'])) ?>
                                            </p>
                                            <p class="mb-0">
                                                <i class="bi bi-person"></i> <?= $vehicule['places'] ?> places disponibles
                                            </p>
                                        </div>
                                    </div>
                                    <div class="btn-group-vertical">
                                        <button class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <?php } ?>
                        <?php } else { ?>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Aucun véhicule enregistré. Ajoutez votre premier véhicule pour proposer des trajets.
                            </div>
                        <?php } ?>
                    </div>
                </div>

                <!-- Section Préférences (si chauffeur) -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="h5 fw-bold mb-0">
                                <i class="bi bi-sliders"></i> Mes préférences de trajet
                            </h2>
                            <button class="btn btn-search btn-sm" data-bs-toggle="modal" data-bs-target="#addPreferenceModal">
                                <i class="bi bi-plus-circle"></i> Ajouter une préférence
                            </button>
                        </div>

                        <div class="preferences-list">
                            <?php foreach ($user['preferences'] as $key => $value) { ?>
                            <div class="preference-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded">
                                <div>
                                    <strong><?= ucfirst(str_replace('_', ' ', $key)) ?>:</strong>
                                    <span class="text-muted">
                                        <?php if (is_bool($value)) {
                                            echo $value ? '<i class="bi bi-check-circle-fill text-success"></i> Oui' : '<i class="bi bi-x-circle-fill text-danger"></i> Non';
                                        } else {
                                            echo htmlspecialchars($value);
                                        } ?>
                                    </span>
                                </div>
                                <button class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <?php } ?>
                        </div>
                    </div>
                </div>

                <!-- Section Proposer un trajet -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="h5 fw-bold mb-3">
                            <i class="bi bi-plus-square"></i> Proposer un nouveau trajet
                        </h2>
                        <form method="POST" action="create_trajet.php">
                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold" for="depart">
                                        <i class="bi bi-geo-alt-fill"></i> Départ
                                    </label>
                                    <input type="text" class="form-control" id="depart" name="depart" 
                                           placeholder="Adresse de départ" required>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold" for="arrivee">
                                        <i class="bi bi-geo-alt"></i> Arrivée
                                    </label>
                                    <input type="text" class="form-control" id="arrivee" name="arrivee" 
                                           placeholder="Adresse d'arrivée" required>
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label fw-semibold" for="date_trajet">
                                        <i class="bi bi-calendar"></i> Date
                                    </label>
                                    <input type="date" class="form-control" id="date_trajet" name="date_trajet" required>
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label fw-semibold" for="heure_trajet">
                                        <i class="bi bi-clock"></i> Heure
                                    </label>
                                    <input type="time" class="form-control" id="heure_trajet" name="heure_trajet" required>
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label fw-semibold" for="prix">
                                        <i class="bi bi-currency-euro"></i> Prix (crédits)
                                    </label>
                                    <input type="number" class="form-control" id="prix" name="prix" 
                                           placeholder="Ex: 20" min="3" required>
                                    <small class="text-muted">2 crédits seront prélevés par la plateforme</small>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold" for="vehicule_id">
                                        <i class="bi bi-car-front"></i> Véhicule
                                    </label>
                                    <select class="form-select" id="vehicule_id" name="vehicule_id" required>
                                        <option value="">Sélectionnez un véhicule</option>
                                        <?php foreach ($user['vehicules'] as $vehicule) { ?>
                                            <option value="<?= $vehicule['id'] ?>">
                                                <?= htmlspecialchars($vehicule['marque']) ?> <?= htmlspecialchars($vehicule['modele']) ?> 
                                                (<?= htmlspecialchars($vehicule['immatriculation']) ?>) - <?= $vehicule['places'] ?> places
                                            </option>
                                        <?php } ?>
                                        <option value="nouveau">+ Ajouter un nouveau véhicule</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold" for="description">
                                        <i class="bi bi-chat-left-text"></i> Description (optionnel)
                                    </label>
                                    <textarea class="form-control" id="description" name="description" rows="3" 
                                              placeholder="Informations complémentaires sur le trajet..."></textarea>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-search w-100">
                                        <i class="bi bi-check-circle"></i> Publier le trajet
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <?php } else { ?>
                <!-- Message si passager uniquement -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Vous êtes actuellement en mode passager uniquement. 
                    Activez le mode "Chauffeur" pour proposer des trajets et gérer vos véhicules.
                </div>
                <?php } ?>

                <!-- Section Mes trajets (visible pour tous) -->
                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h2 class="h5 fw-bold mb-3">
                            <i class="bi bi-list-ul"></i> Mes trajets
                        </h2>
                        <ul class="nav nav-tabs mb-3" role="tablist">
                            <?php if (in_array($user['role'], ['chauffeur', 'chauffeur-passager'])) { ?>
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#trajets-proposes">
                                    Trajets proposés
                                </button>
                            </li>
                            <?php } ?>
                            <li class="nav-item">
                                <button class="nav-link <?= $user['role'] === 'passager' ? 'active' : '' ?>" 
                                        data-bs-toggle="tab" data-bs-target="#trajets-reserves">
                                    Trajets réservés
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <?php if (in_array($user['role'], ['chauffeur', 'chauffeur-passager'])) { ?>
                            <div class="tab-pane fade show active" id="trajets-proposes">
                                <p class="text-muted text-center py-3">
                                    <i class="bi bi-calendar-x"></i> Aucun trajet proposé pour le moment
                                </p>
                            </div>
                            <?php } ?>
                            <div class="tab-pane fade <?= $user['role'] === 'passager' ? 'show active' : '' ?>" id="trajets-reserves">
                                <p class="text-muted text-center py-3">
                                    <i class="bi bi-calendar-x"></i> Aucun trajet réservé pour le moment
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal Ajouter un véhicule -->
<div class="modal fade" id="addVehicleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-car-front"></i> Ajouter un véhicule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="add_vehicle.php">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="marque">Marque *</label>
                        <input type="text" class="form-control" id="marque" name="marque" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="modele">Modèle *</label>
                        <input type="text" class="form-control" id="modele" name="modele" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="couleur">Couleur *</label>
                        <input type="text" class="form-control" id="couleur" name="couleur" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="immatriculation">Plaque d'immatriculation *</label>
                        <input type="text" class="form-control" id="immatriculation" name="immatriculation" 
                               placeholder="AA-123-BB" pattern="[A-Z]{2}-[0-9]{3}-[A-Z]{2}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="date_immatriculation">Date de 1ère immatriculation *</label>
                        <input type="date" class="form-control" id="date_immatriculation" name="date_immatriculation" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="places">Nombre de places disponibles *</label>
                        <select class="form-select" id="places" name="places" required>
                            <option value="">Sélectionnez...</option>
                            <option value="1">1 place</option>
                            <option value="2">2 places</option>
                            <option value="3">3 places</option>
                            <option value="4">4 places</option>
                            <option value="5">5 places</option>
                            <option value="6">6 places</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="electrique" name="electrique" value="1">
                            <label class="form-check-label" for="electrique">
                                <i class="bi bi-ev-front"></i> Véhicule électrique
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-search">
                        <i class="bi bi-plus-circle"></i> Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ajouter une préférence -->
<div class="modal fade" id="addPreferenceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-sliders"></i> Ajouter une préférence</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="add_preference.php">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="pref_name">Nom de la préférence *</label>
                        <input type="text" class="form-control" id="pref_name" name="pref_name" 
                               placeholder="Ex: Musique, Climatisation..." required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="pref_value">Valeur *</label>
                        <input type="text" class="form-control" id="pref_value" name="pref_value" 
                               placeholder="Ex: Autorisée, Non autorisée..." required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-search">
                        <i class="bi bi-plus-circle"></i> Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<?php include __DIR__ . '/footer.phtml'; ?>